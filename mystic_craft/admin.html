<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Payment Records</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; background: #f4f6f9; }
    h2 { color: #333; margin-bottom: 14px; }
    .actions { margin: 16px 0; display:flex; gap:10px; flex-wrap:wrap; }
    .btn { padding:10px 14px; border:none; border-radius:6px; cursor:pointer; font-size:.95rem; }
    .btn-clear { background:#dc3545; color:#fff; } .btn-clear:hover{ background:#c82333; }
    .btn-export { background:#28a745; color:#fff; } .btn-export:hover{ background:#218838; }
    .btn-back { background:#6c757d; color:#fff; } .btn-back:hover{ background:#5a6268; }
    .filters { margin: 16px 0; display:flex; gap:12px; flex-wrap:wrap; }
    .filters input, .filters select { padding:8px 10px; border-radius:6px; border:1px solid #ccc; font-size:.95rem; }
    table { width:100%; border-collapse:collapse; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.08); }
    th, td { padding:12px 15px; border:1px solid #ddd; text-align:left; vertical-align:top; }
    th { background:#007BFF; color:#fff; }
    tr:nth-child(even){ background:#f9f9f9; }
    .empty { margin-top: 20px; font-size: 1.05em; color: #555; }
  </style>
</head>
<body>
  <h2>Payment Records</h2>

  <div class="actions">
    <a class="btn btn-back" href="index.html">‚Üê Back to Store</a>
    <button class="btn btn-export" onclick="exportCSV()">Export to CSV</button>
    <button class="btn btn-clear" onclick="clearPayments()">Clear All Records</button>
  </div>

  <div class="filters">
    <input type="text" id="searchUPI" placeholder="Search UPI ID..." oninput="applyFilters()">
    <select id="filterMethod" onchange="applyFilters()">
      <option value="">All Methods</option>
      <option value="UPI">UPI</option>
      <option value="Google Pay">Google Pay</option>
      <option value="PhonePe">PhonePe</option>
      <option value="Bank Transfer">Bank Transfer</option>
    </select>
  </div>

  <div id="paymentTable"></div>

  <script>
    let allPayments = [];

    async function loadPayments(){
      try{
        const res = await fetch('/api/payments');
        if(!res.ok) throw new Error('no server');
        allPayments = await res.json();
      }catch(e){
        allPayments = JSON.parse(localStorage.getItem('payments')) || [];
      }
      applyFilters();
    }

    function renderTable(rows){
      const container = document.getElementById('paymentTable');
      if(rows.length===0){ container.innerHTML = "<p class='empty'>No matching records found.</p>"; return; }
      let html = `<table>
        <tr><th>Date</th><th>Method</th><th>UPI ID</th><th>Items</th></tr>`;
      rows.forEach(p=>{
        const items = (p.cartItems||[]).map(i=>`${i.name} (x${i.quantity})`).join(', ');
        html += `<tr>
          <td>${p.date}</td>
          <td>${p.method}</td>
          <td>${p.upiId || '-'}</td>
          <td>${items}</td>
        </tr>`;
      });
      html += `</table>`;
      container.innerHTML = html;
    }

    function applyFilters(){
      const q = document.getElementById('searchUPI').value.toLowerCase();
      const method = document.getElementById('filterMethod').value;
      const filtered = allPayments.filter(p=>{
        const upiOk = !q || (p.upiId && p.upiId.toLowerCase().includes(q));
        const methodOk = !method || p.method === method;
        return upiOk && methodOk;
      });
      renderTable(filtered);
    }

    async function clearPayments(){
      if(!confirm('Are you sure you want to clear all records?')) return;
      try{
        const res = await fetch('/api/payments', {method:'DELETE'});
        if(!res.ok) throw new Error('server');
        allPayments = [];
      }catch(e){
        localStorage.removeItem('payments'); allPayments = [];
      }
      applyFilters();
    }

    function exportCSV(){
      if(allPayments.length===0){ alert('No payment records to export.'); return; }
      let csv = 'Date,Method,UPI ID,Items\n';
      allPayments.forEach(p=>{
        const items = (p.cartItems||[]).map(i=>`${i.name} (x${i.quantity})`).join(' | ');
        csv += `"${p.date}","${p.method}","${p.upiId || '-'}","${items}"\n`;
      });
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'payment_records.csv'; a.click();
    }

    loadPayments();
  </script>
</body>
</html>
